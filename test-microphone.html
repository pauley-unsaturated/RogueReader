<!DOCTYPE html>
<html>
<head>
    <title>Microphone Test for RogueReader</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .container {
            background: #2a2a2a;
            padding: 30px;
            border-radius: 10px;
        }
        h1 {
            color: #00ff00;
        }
        button {
            padding: 10px 20px;
            margin: 10px;
            font-size: 16px;
            background: #00ff00;
            color: #000;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background: #00dd00;
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        #status {
            margin: 20px 0;
            padding: 15px;
            background: #333;
            border-radius: 5px;
            min-height: 100px;
        }
        #audioLevel {
            width: 100%;
            height: 30px;
            background: #444;
            border-radius: 5px;
            overflow: hidden;
            margin: 20px 0;
        }
        #audioLevelBar {
            height: 100%;
            background: linear-gradient(to right, #00ff00, #ffff00, #ff0000);
            width: 0%;
            transition: width 0.1s;
        }
        .device-list {
            margin: 20px 0;
        }
        select {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            background: #333;
            color: #fff;
            border: 1px solid #555;
            border-radius: 5px;
        }
        .log-entry {
            font-family: monospace;
            margin: 5px 0;
            padding: 5px;
            background: rgba(0,255,0,0.1);
            border-left: 3px solid #00ff00;
        }
        .error {
            background: rgba(255,0,0,0.1);
            border-left-color: #ff0000;
            color: #ff6666;
        }
        #recordingIndicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            background: #ff0000;
            border-radius: 50%;
            margin-left: 10px;
            visibility: hidden;
        }
        #recordingIndicator.active {
            visibility: visible;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎤 RogueReader Microphone Test</h1>

        <div class="device-list">
            <h3>Select Audio Input Device:</h3>
            <select id="audioDeviceSelect">
                <option value="">Loading devices...</option>
            </select>
        </div>

        <div>
            <button id="testMicBtn">Test Microphone</button>
            <button id="stopBtn" disabled>Stop</button>
            <button id="recordBtn">Record 3 Seconds</button>
            <button id="whisperBtn" disabled>Test Whisper API</button>
            <span id="recordingIndicator"></span>
        </div>

        <div id="audioLevel">
            <div id="audioLevelBar"></div>
        </div>

        <div id="status">
            <div class="log-entry">👋 Ready to test microphone...</div>
        </div>
    </div>

    <script>
        let audioStream = null;
        let mediaRecorder = null;
        let audioContext = null;
        let analyser = null;
        let microphone = null;
        let javascriptNode = null;
        let audioChunks = [];
        let selectedDeviceId = null;

        const statusEl = document.getElementById('status');
        const testBtn = document.getElementById('testMicBtn');
        const stopBtn = document.getElementById('stopBtn');
        const recordBtn = document.getElementById('recordBtn');
        const whisperBtn = document.getElementById('whisperBtn');
        const deviceSelect = document.getElementById('audioDeviceSelect');
        const audioLevelBar = document.getElementById('audioLevelBar');
        const recordingIndicator = document.getElementById('recordingIndicator');

        function log(message, isError = false) {
            const entry = document.createElement('div');
            entry.className = isError ? 'log-entry error' : 'log-entry';
            entry.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
            statusEl.appendChild(entry);
            statusEl.scrollTop = statusEl.scrollHeight;
            console.log(message);
        }

        async function loadAudioDevices() {
            try {
                // Request permission first to see all devices
                await navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                    stream.getTracks().forEach(track => track.stop());
                });

                const devices = await navigator.mediaDevices.enumerateDevices();
                const audioInputs = devices.filter(device => device.kind === 'audioinput');

                deviceSelect.innerHTML = '';

                if (audioInputs.length === 0) {
                    deviceSelect.innerHTML = '<option value="">No audio inputs found</option>';
                    log('❌ No audio input devices found!', true);
                    return;
                }

                audioInputs.forEach((device, index) => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.text = device.label || `Microphone ${index + 1}`;
                    deviceSelect.appendChild(option);
                });

                log(`✅ Found ${audioInputs.length} audio input device(s)`);

                // Log all devices for debugging
                audioInputs.forEach(device => {
                    log(`  📍 ${device.label || 'Unknown Device'} (${device.deviceId.substring(0, 8)}...)`);
                });

            } catch (error) {
                log(`Failed to load audio devices: ${error.message}`, true);
            }
        }

        async function startMicrophoneTest() {
            try {
                selectedDeviceId = deviceSelect.value;

                log(`🎙️ Starting microphone test with device: ${deviceSelect.options[deviceSelect.selectedIndex].text}`);

                const constraints = {
                    audio: {
                        deviceId: selectedDeviceId ? { exact: selectedDeviceId } : undefined,
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        sampleRate: 16000
                    }
                };

                audioStream = await navigator.mediaDevices.getUserMedia(constraints);

                const track = audioStream.getAudioTracks()[0];
                log(`✅ Microphone active: ${track.label}`);
                log(`  Settings: ${JSON.stringify(track.getSettings())}`);

                // Set up audio level monitoring
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(audioStream);
                javascriptNode = audioContext.createScriptProcessor(2048, 1, 1);

                analyser.smoothingTimeConstant = 0.8;
                analyser.fftSize = 1024;

                microphone.connect(analyser);
                analyser.connect(javascriptNode);
                javascriptNode.connect(audioContext.destination);

                javascriptNode.onaudioprocess = function() {
                    const array = new Uint8Array(analyser.frequencyBinCount);
                    analyser.getByteFrequencyData(array);
                    const values = array.reduce((a, b) => a + b, 0);
                    const average = values / array.length;
                    const percentage = Math.min(100, (average / 128) * 100);
                    audioLevelBar.style.width = percentage + '%';
                };

                testBtn.disabled = true;
                stopBtn.disabled = false;
                recordBtn.disabled = true;

            } catch (error) {
                log(`❌ Failed to start microphone: ${error.message}`, true);

                if (error.name === 'NotAllowedError') {
                    log('🔒 Microphone permission denied. Please allow microphone access in Safari settings.', true);
                    log('   Go to Safari > Settings > Websites > Microphone', true);
                } else if (error.name === 'NotFoundError') {
                    log('🎤 No microphone found. Check your USB webcam connection.', true);
                }
            }
        }

        function stopMicrophoneTest() {
            if (audioStream) {
                audioStream.getTracks().forEach(track => track.stop());
                audioStream = null;
            }

            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }

            audioLevelBar.style.width = '0%';
            testBtn.disabled = false;
            stopBtn.disabled = true;
            recordBtn.disabled = false;

            log('🛑 Microphone test stopped');
        }

        async function recordAudio() {
            try {
                audioChunks = [];

                const constraints = {
                    audio: {
                        deviceId: selectedDeviceId ? { exact: selectedDeviceId } : undefined,
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 16000
                    }
                };

                const stream = await navigator.mediaDevices.getUserMedia(constraints);

                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'audio/webm;codecs=opus'
                });

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    log(`✅ Recorded ${(audioBlob.size / 1024).toFixed(2)} KB of audio`);
                    whisperBtn.disabled = false;
                    recordingIndicator.classList.remove('active');

                    // Play back the recording
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audio = new Audio(audioUrl);
                    audio.play();
                    log('🔊 Playing back recording...');
                };

                mediaRecorder.start();
                recordingIndicator.classList.add('active');
                log('🔴 Recording for 3 seconds... Say "hello"!');
                recordBtn.disabled = true;

                setTimeout(() => {
                    mediaRecorder.stop();
                    stream.getTracks().forEach(track => track.stop());
                    recordBtn.disabled = false;
                }, 3000);

            } catch (error) {
                log(`❌ Recording failed: ${error.message}`, true);
                recordBtn.disabled = false;
            }
        }

        async function testWhisperAPI() {
            if (audioChunks.length === 0) {
                log('❌ No audio recorded', true);
                return;
            }

            try {
                log('🔄 Sending audio to Whisper API...');
                whisperBtn.disabled = true;

                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                const formData = new FormData();
                formData.append('file', audioBlob, 'audio.webm');
                formData.append('model', 'whisper-1');
                formData.append('language', 'en');

                // Get API key from environment (you'll need to add it)
                const apiKey = prompt('Enter your OpenAI API key:');

                if (!apiKey) {
                    log('❌ API key required', true);
                    whisperBtn.disabled = false;
                    return;
                }

                const response = await fetch('https://api.openai.com/v1/audio/transcriptions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    log(`✅ Whisper transcription: "${data.text}"`);
                } else {
                    const error = await response.text();
                    log(`❌ Whisper API error: ${error}`, true);
                }

            } catch (error) {
                log(`❌ Failed to call Whisper API: ${error.message}`, true);
            } finally {
                whisperBtn.disabled = false;
            }
        }

        // Event listeners
        testBtn.addEventListener('click', startMicrophoneTest);
        stopBtn.addEventListener('click', stopMicrophoneTest);
        recordBtn.addEventListener('click', recordAudio);
        whisperBtn.addEventListener('click', testWhisperAPI);
        deviceSelect.addEventListener('change', () => {
            log(`📍 Selected device: ${deviceSelect.options[deviceSelect.selectedIndex].text}`);
            if (audioStream) {
                stopMicrophoneTest();
            }
        });

        // Load devices on page load
        loadAudioDevices();

        // Reload devices when they change
        navigator.mediaDevices.addEventListener('devicechange', loadAudioDevices);

        // Instructions
        log('ℹ️ macOS/Safari Microphone Setup:');
        log('  1. System Settings > Sound > Input > Select your USB webcam');
        log('  2. Safari > Settings > Websites > Microphone > Allow for localhost');
        log('  3. Select your USB webcam from the dropdown above');
        log('  4. Click "Test Microphone" to see audio levels');
        log('  5. Click "Record 3 Seconds" to test recording');
    </script>
</body>
</html>